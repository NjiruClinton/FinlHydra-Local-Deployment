{"version":3,"file":"6-7cd7d35e.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/login/callback/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/6.js"],"sourcesContent":["import { e as error, r as redirect } from \"../../../../chunks/index.js\";\nimport { b as refreshSessionCookie, a as authCondition, v as validateAndParseCsrfToken, c as getOIDCUserData } from \"../../../../chunks/auth.js\";\nimport { z } from \"zod\";\nimport { b as base } from \"../../../../chunks/paths.js\";\nimport { c as collections } from \"../../../../chunks/database.js\";\nimport { ObjectId } from \"mongodb\";\nimport { D as DEFAULT_SETTINGS } from \"../../../../chunks/Settings.js\";\nasync function updateUser(params) {\n  const { userData, locals, cookies } = params;\n  const {\n    preferred_username: username,\n    name,\n    email,\n    picture: avatarUrl,\n    sub: hfUserId\n  } = z.object({\n    preferred_username: z.string().optional(),\n    name: z.string(),\n    picture: z.string(),\n    sub: z.string(),\n    email: z.string().email().optional()\n  }).refine((data) => data.preferred_username || data.email, {\n    message: \"Either preferred_username or email must be provided by the provider.\"\n  }).parse(userData);\n  const existingUser = await collections.users.findOne({ hfUserId });\n  let userId = existingUser?._id;\n  if (existingUser) {\n    await collections.users.updateOne(\n      { _id: existingUser._id },\n      { $set: { username, name, avatarUrl } }\n    );\n    refreshSessionCookie(cookies, existingUser.sessionId);\n  } else {\n    const { insertedId } = await collections.users.insertOne({\n      _id: new ObjectId(),\n      createdAt: /* @__PURE__ */ new Date(),\n      updatedAt: /* @__PURE__ */ new Date(),\n      username,\n      name,\n      email,\n      avatarUrl,\n      hfUserId,\n      sessionId: locals.sessionId\n    });\n    userId = insertedId;\n    const { matchedCount } = await collections.settings.updateOne(authCondition(locals), {\n      $set: { userId, updatedAt: /* @__PURE__ */ new Date() },\n      $unset: { sessionId: \"\" }\n    });\n    if (!matchedCount) {\n      await collections.settings.insertOne({\n        userId,\n        ethicsModalAcceptedAt: /* @__PURE__ */ new Date(),\n        updatedAt: /* @__PURE__ */ new Date(),\n        createdAt: /* @__PURE__ */ new Date(),\n        ...DEFAULT_SETTINGS\n      });\n    }\n  }\n  await collections.conversations.updateMany(authCondition(locals), {\n    $set: { userId },\n    $unset: { sessionId: \"\" }\n  });\n}\nasync function load({ url, locals, cookies }) {\n  const { error: errorName, error_description: errorDescription } = z.object({\n    error: z.string().optional(),\n    error_description: z.string().optional()\n  }).parse(Object.fromEntries(url.searchParams.entries()));\n  if (errorName) {\n    throw error(400, errorName + (errorDescription ? \": \" + errorDescription : \"\"));\n  }\n  const { code, state } = z.object({\n    code: z.string(),\n    state: z.string()\n  }).parse(Object.fromEntries(url.searchParams.entries()));\n  const csrfToken = Buffer.from(state, \"base64\").toString(\"utf-8\");\n  const validatedToken = await validateAndParseCsrfToken(csrfToken, locals.sessionId);\n  if (!validatedToken) {\n    throw error(403, \"Invalid or expired CSRF token\");\n  }\n  const { userData } = await getOIDCUserData({ redirectURI: validatedToken.redirectUrl }, code);\n  await updateUser({ userData, locals, cookies });\n  throw redirect(302, `${base}/`);\n}\nexport {\n  load\n};\n","import * as server from '../entries/pages/login/callback/_page.server.ts.js';\n\nexport const index = 6;\nexport { server };\nexport const server_id = \"src/routes/login/callback/+page.server.ts\";\nexport const imports = [];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}